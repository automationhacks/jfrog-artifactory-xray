package backend.e2e.tests;

import static io.automationhacks.backend.core.object.Serialization.serialize;

import backend.e2e.assertion.RepositoryAssertion;
import backend.e2e.assertion.XrayAssertion;
import backend.e2e.helper.TestHelper;

import io.automationhacks.backend.core.constants.DateTimeConstants;
import io.automationhacks.backend.core.utils.DateTimeUtils;
import io.automationhacks.backend.core.utils.StringUtils;
import io.automationhacks.backend.domain.artifactory.client.repositories.RepositoryClient;
import io.automationhacks.backend.domain.artifactory.model.repositories.CreateRepositoryRequest;
import io.automationhacks.backend.domain.xray.client.XrayClient;
import io.automationhacks.backend.domain.xray.model.apply_watch.ApplyWatchRequestBuilder;
import io.automationhacks.backend.domain.xray.model.create_security_policy.CreateSecurityPolicyRequestBuilder;
import io.automationhacks.backend.domain.xray.model.create_watch.CreateWatchRequestBuilder;
import io.automationhacks.backend.domain.xray.model.get_violations.request.ArtifactsItem;
import io.automationhacks.backend.domain.xray.model.get_violations.request.GetViolationsRequestBuilder;
import io.automationhacks.backend.domain.xray.model.scan_status.ScanStatusRequest;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.testng.annotations.Test;

public class VulnerabilityScanByPolicyTest {
    private final Logger logger = LoggerFactory.getLogger(VulnerabilityScanByPolicyTest.class);

    @Test
    public void testVulnerabilityScanByPolicy() {
        var repositoryClient = new RepositoryClient();

        String repoKey = "docker-local-%s".formatted(StringUtils.getRandomString());
        logger.info("Creating repository with key: %s".formatted(repoKey));

        var createRepositoryRequest =
                CreateRepositoryRequest.builder()
                        .projectKey("")
                        .rclass("local")
                        .xrayIndex(true)
                        .packageType("docker")
                        .key(repoKey)
                        .build();

        var body = serialize(createRepositoryRequest);
        var response = repositoryClient.createRepository(repoKey, body);
        var repositoryAssertion = new RepositoryAssertion();
        repositoryAssertion.verifyRepositoryIsCreated(repoKey, response);

        var repositoriesResponse = repositoryClient.getRepositories();
        repositoryAssertion.verifyLocalRepositoryIsPresent(repoKey, repositoriesResponse);

        var testHelper = new TestHelper();
        testHelper.pushImageToRepository(repoKey, "alpine:3.9");

        var xRayClient = new XrayClient();
        String secPolicyName = "%s_policy".formatted(repoKey);
        var createSecurityPolicyRequest =
                new CreateSecurityPolicyRequestBuilder()
                        .withNameDescription(
                                secPolicyName, "Security policy with min severity as high")
                        .build();
        var createSecurityPolicyResponse =
                xRayClient.createSecurityPolicy(serialize(createSecurityPolicyRequest));

        var xrayAssertion = new XrayAssertion();
        xrayAssertion.verifySecurityPolicyIsCreated(createSecurityPolicyResponse);

        String watchName = "%s_watch".formatted(repoKey);
        var createWatchRequest =
                new CreateWatchRequestBuilder()
                        .withWatchAndPolicyName(watchName, secPolicyName)
                        .withProjectResourcesName(repoKey)
                        .build();
        var createWatchResponse = xRayClient.createWatch(serialize(createWatchRequest));
        xrayAssertion.verifyWatchIsCreated(createWatchResponse);

        var applyWatchRequest =
                new ApplyWatchRequestBuilder()
                        .withWatchName(watchName)
                        .withDates(
                                DateTimeUtils.getDateTime(-5, DateTimeConstants.DATE_TIME_FORMAT),
                                DateTimeUtils.getDateTime(5, DateTimeConstants.DATE_TIME_FORMAT))
                        .build();
        var applyWatchResponse = xRayClient.applyWatch(serialize(applyWatchRequest));
        xrayAssertion.verifyWatchIsAppliedOnPolicy(applyWatchResponse);

        var scanStatusRequest =
                ScanStatusRequest.builder().repo(repoKey).path("alpine/3.9/manifest.json").build();
        String scanStatusRequestStr = serialize(scanStatusRequest);
        var scanStatusResponse = xRayClient.getScanStatus(scanStatusRequestStr);
        testHelper.waitForXRayScanToBeDone(scanStatusRequestStr);
        xrayAssertion.verifyXrayScanReturnsSuccess(scanStatusResponse, repoKey);

        var getViolationsRequest =
                new GetViolationsRequestBuilder()
                        .withWatchName(watchName)
                        .withArtifact(
                                ArtifactsItem.builder()
                                        .path("alpine/3.9/manifest.json")
                                        .repo(repoKey)
                                        .build())
                        .build();
        var getViolationsResponse = xRayClient.getViolations(serialize(getViolationsRequest));
        xrayAssertion.verifyViolationsAreGenerated(getViolationsResponse);
    }
}
