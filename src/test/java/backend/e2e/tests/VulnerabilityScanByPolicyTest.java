package backend.e2e.tests;

import backend.e2e.assertion.RepositoryAssertion;

import io.automationhacks.backend.core.object.Serialization;
import io.automationhacks.backend.core.utils.StringUtils;
import io.automationhacks.backend.domain.artifactory.client.repositories.RepositoryClient;
import io.automationhacks.backend.domain.artifactory.model.repositories.CreateRepositoryRequest;

import org.testng.annotations.Test;

public class VulnerabilityScanByPolicyTest {
    @Test
    public void testVulnerabilityScanByPolicy() {
        var repositoryClient = new RepositoryClient();

        String repoKey = "docker-local-%s".formatted(StringUtils.getRandomString());
        var createRepositoryRequest =
                CreateRepositoryRequest.builder()
                        .projectKey("")
                        .rclass("local")
                        .xrayIndex(true)
                        .packageType("docker")
                        .key(repoKey)
                        .build();

        var body = Serialization.serialize(createRepositoryRequest);
        var response = repositoryClient.createRepository(repoKey, body);
        var repositoryAssertion = new RepositoryAssertion();
        repositoryAssertion.verifyRepositoryIsCreated(repoKey, response);

        var repositoriesResponse = repositoryClient.getRepositories();
        repositoryAssertion.verifyLocalRepositoryIsPresent(repoKey, repositoriesResponse);
    }
}
