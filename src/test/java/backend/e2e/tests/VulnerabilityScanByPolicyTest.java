package backend.e2e.tests;

import static io.automationhacks.backend.core.env.Environment.getPassword;
import static io.automationhacks.backend.core.env.Environment.getUsername;

import backend.e2e.assertion.XrayUIAssertions;
import backend.e2e.flow.ArtifactoryFlow;
import backend.e2e.flow.XrayFlow;
import backend.e2e.helper.TestHelper;

import io.automationhacks.backend.core.env.Environment;
import io.automationhacks.backend.core.utils.StringUtils;
import io.automationhacks.web.core.constant.Browser;
import io.automationhacks.web.core.driver.DriverFactory;
import io.automationhacks.web.domain.constants.PageUrls;
import io.automationhacks.web.domain.page_objects.common.LoadingPage;
import io.automationhacks.web.domain.page_objects.login.LoginPage;
import io.automationhacks.web.domain.page_objects.xray.scans_list.ArtifactsPage;

import org.openqa.selenium.WebDriver;
import org.testng.annotations.AfterMethod;
import org.testng.annotations.BeforeMethod;
import org.testng.annotations.Test;

public class VulnerabilityScanByPolicyTest {
    private final WebDriver driver = new DriverFactory(Browser.CHROME).getDriver();
    private final String jFrogUI = Environment.getJFrogUI();

    @BeforeMethod
    public void setUp() {
        driver.get(jFrogUI);

        var loadingPage = new LoadingPage(driver);
        loadingPage.waitForAnimationToFinish();
    }

    @Test
    public void testVulnerabilityScanByPolicy() {
        String repoKey = "docker-local-%s".formatted(StringUtils.getRandomString());
        new ArtifactoryFlow().createRepositoryInArtifactory(repoKey);

        var testHelper = new TestHelper();

        String dockerImage = "alpine:3.9";
        testHelper.pushImageToRepository(
                repoKey, dockerImage, dockerImage, Environment.getHostName());

        String secPolicyName = "%s_policy".formatted(repoKey);
        var xRayFlow = new XrayFlow();
        xRayFlow.createSecurityPolicy(secPolicyName);

        String watchName = "%s_watch".formatted(repoKey);
        xRayFlow.createWatch(repoKey, watchName, secPolicyName);
        xRayFlow.applyWatchOnPolicy(watchName, -5, 5);

        String artifactPath = "alpine/3.9/manifest.json";
        xRayFlow.checkScanIsDone(repoKey, artifactPath);
        xRayFlow.checkViolationsAreGenerated(repoKey, artifactPath, watchName);

        var loginPage = new LoginPage(driver);
        var loginPageText = loginPage.getLoginPageBanner();

        XrayUIAssertions xrayUIAssertions = new XrayUIAssertions();
        xrayUIAssertions.verifyLoginPageBanner(loginPageText);

        loginPage.waitForLoginPageToLoad();
        loginPage.login(getUsername(), getPassword());

        new LoadingPage(driver).waitForAnimationToFinish();

        String url = PageUrls.XRAY_SCAN_LIST.formatted(jFrogUI, repoKey);
        driver.get(url);

        var basePath = "alpine/3.9";
        var artifactSelectorPath = "%s/alpine/3.9/manifest.json".formatted(basePath);
        var artifactsPage = new ArtifactsPage(driver);
        artifactsPage.clickOnVulnerabilities(artifactSelectorPath);

        var severityCounts = artifactsPage.getPolicyViolations();
        xrayUIAssertions.verifyPolicyViolationsBelowHighAreNotReported(severityCounts);
    }

    @AfterMethod
    public void teardown() {
        driver.close();
        driver.quit();
    }
}
